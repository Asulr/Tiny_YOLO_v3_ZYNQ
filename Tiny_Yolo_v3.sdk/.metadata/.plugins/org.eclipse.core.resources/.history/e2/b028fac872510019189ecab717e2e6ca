/*
 * image.c
 *
 *  Created on: Mar 28, 2019
 *      Author: xavier
 */

#include "image.h"
#include "utils.h"
#include "blas.h"
#include <stdio.h>
#include <math.h>
#include "input_image.h"

image make_empty_image(int w, int h, int c)
{
    image out;
    out.data = 0;
    out.h = h;
    out.w = w;
    out.c = c;
    return out;
}

image make_image(int w, int h, int c)
{
    image out = make_empty_image(w,h,c);
    out.data = calloc(h*w*c, sizeof(float));
    return out;
}

image load_image_stb(int channels)
{
    int w, h, c;
    w = InputImage_w;
    h = InputImage_h;
    c = InputImage_c;

    //unsigned char *data = stbi_load(filename, &w, &h, &c, channels);
    //if (!data) {
    //    fprintf(stderr, "Cannot load image \"%s\"\nSTB Reason: %s\n", filename, stbi_failure_reason());
    //    exit(0);
    //}
    if(channels) c = channels;
    int i,j,k;
    image im = make_image(w, h, c);
    for(k = 0; k < c; ++k){
        for(j = 0; j < h; ++j){
            for(i = 0; i < w; ++i){
                int dst_index = i + w*j + w*h*k;
                //int src_index = k + c*i + c*w*j;
                im.data[dst_index] = InputImage[dst_index];
            }
        }
    }
    //free(data);
    return im;
}

image load_image(int w, int h, int c)
{
    image out = load_image_stb(c);

    //if((h && w) && (h != out.h || w != out.w)){
    //    image resized = resize_image(out, w, h);
    //    free_image(out);
    //    out = resized;
    //}
    return out;
}

image load_image_color(int w, int h)
{
    return load_image(w, h, 3);
}

image letterbox_image(image im, int w, int h)
{
    int new_w = im.w;
    int new_h = im.h;
    if (((float)w/im.w) < ((float)h/im.h)) {
        new_w = w;
        new_h = (im.h * w)/im.w;
    } else {
        new_h = h;
        new_w = (im.w * h)/im.h;
    }
    image resized = resize_image(im, new_w, new_h);
    image boxed = make_image(w, h, im.c);
    fill_image(boxed, .5);
    //int i;
    //for(i = 0; i < boxed.w*boxed.h*boxed.c; ++i) boxed.data[i] = 0;
    embed_image(resized, boxed, (w-new_w)/2, (h-new_h)/2);
    free_image(resized);
    return boxed;
}


